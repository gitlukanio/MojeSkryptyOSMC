
 * WstÄ™p

Poradnik ten przeznaczony jest dla bardzo poczÄ…tkujÄ…cych uÅ¼ytkownikÃ³w (nawet zupeÅ‚nych lamerÃ³w) systemu Linux, ktÃ³rzy chcieliby zajÄ…Ä‡ siÄ™ tematem bezpieczeÅ„stwa swojego serwera, zanim zrobi to za nich ktoÅ› innyâ€¦

 * StawiajÄ…c serwer do zabawy i nauki, moÅ¼esz zdecydowaÄ‡ siÄ™ na absolutnie dowolnÄ… dystrybucjÄ™.

WybierajÄ…c jednak OS do zastosowaÅ„ produkcyjnych, warto zdecydowaÄ‡ siÄ™ na dystrybucjÄ™ po pierwsze sprawdzonÄ…, po drugie, czÄ™sto aktualizowanÄ….

Do najpopularniejszych (darmowych) naleÅ¼Ä…:

    Ubuntu
    CentOS
    Debian

    Fakt, Å¼e producent czÄ™sto aktualizuje system, nie podnosi Twojego bezpieczeÅ„stwa, jeÅ›liâ€¦ Ty regularnie nie Å›ciÄ…gasz tych nowych aktualizacji ;)

 * Logowanie na serwer

MÃ³wi siÄ™, abyÅ› hasÅ‚a traktowaÅ‚ jak majtki:

    zmieniaj je czÄ™sto,
    nie poÅ¼yczaj znajomym,
    nie zostawiaj na widoku.

W wiÄ™kszoÅ›ci przypadkÃ³w zgadzam siÄ™ z tym podejÅ›ciem, ale w Å›wiecie serwerÃ³w, poszedÅ‚em o krok dalejâ€¦

 * Zapomnij o hasÅ‚ach!

KorzytajÄ…c z prorotkoÅ‚u SSH, moÅ¼esz w peÅ‚ni przerzuciÄ‡ siÄ™ na logowania za pomocÄ… kluczy SSH.

W ten sposÃ³b, nawet jeÅ›li logowaÅ‚byÅ› siÄ™ do serwera np. z komputera z fizycznym/softwarowym keyloggerem, niemoÅ¼liwe stanie siÄ™ przechwycenie hasÅ‚a, poniewaÅ¼â€¦ nie uÅ¼ywasz Å¼adnego.

Dodatkowo niemal niemoÅ¼liwe staje siÄ™ przeprowadzenie typowego ataku bruteforce (prÃ³ba logowania z wykorzystaniem haseÅ‚ sÅ‚ownikowych i/lub haseÅ‚ generowanych kolejno: aaa, aab, aac itd.)

    Dla zwiÄ™kszenia bezpieczeÅ„stwa, moÅ¼esz zdefiniowaÄ‡ hasÅ‚o dla swojego klucza SSH. Da Ci to dodatkowÄ… warstwÄ™ ochrony, na wypadek wycieku klucza.

 * HasÅ‚o awaryjne

KaÅ¼dy admin, ktÃ³ry kiedykolwiek doÅ›wiadczyÅ‚ powaÅ¼nej usterki serwera i musiaÅ‚ na nim interweniowaÄ‡ poprzez konsolÄ™ wirtualnÄ…, fizyczny terminal lub KVM, wie, Å¼e brak moÅ¼liwoÅ›ci zalogowania siÄ™ zwykÅ‚ym hasÅ‚em to jeden z najgorszych spowalniaczy pracy, jaki moÅ¼e siÄ™ przytrafiÄ‡.

Z tego wzglÄ™du warto mieÄ‡ coÅ›, co ja nazywam â€œhasÅ‚em awaryjnymâ€.

    HasÅ‚o awaryjne przechowywane jest w bezpiecznym miejscu, niekoniecznie w Twojej gÅ‚owie.

 * Logowanie awaryjne (przez konsole)

    Ustaw dÅ‚ugie, trudne do zÅ‚amania hasÅ‚o dla uÅ¼ytkownika ROOT (moÅ¼e to byÄ‡ np. zlepek 5â€“6 zupeÅ‚nie losowych sÅ‚Ã³w).
    Zapisz hasÅ‚o w bezpiecznym miejscu (menadÅ¼er haseÅ‚, zaszyfrowany plik na dysku, pendrive w sejfieâ€Šâ€”â€Šcokolwiek).
    Nie prÃ³buj nawet zapamiÄ™taÄ‡ tego hasÅ‚a.
    Ustaw w SSH moÅ¼liwoÅ›Ä‡ logowania jedynie za pomocÄ… kluczy
    Nadal bÄ™dzie daÅ‚o siÄ™ zalogowaÄ‡ do serwera hasÅ‚em poprzez konsolÄ™ awaryjnÄ… (czy to KVM czy fizycznÄ…), ale nie przez protokÃ³Å‚ SSH.

 * Tylko szyfrowane protokoÅ‚y!

Zrezygnuj z uÅ¼ywania protokoÅ‚u FTP. Nawet jeÅ›li na Twoim serwerze sÄ… konta mniej technicznych uÅ¼ytkownikÃ³w, naucz ich korzystania z dowolnej, alternatywnej metody przesyÅ‚ania plikÃ³w.

    SCP
    SFTP
    RSYNC

FTP przesyÅ‚a hasÅ‚a czystym tekstem, wiÄ™c ich przechwycenie jest dziecinnie proste.

 * Konfiguracja firewalla

Podstawowa zasada rozpoczynania konfiguracji firewalla, to:

    Stosuj whitelisty, a nie blacklisty.

Czyli domyÅ›lnie, wszystko ustawione jest na DROP (ruch przychodzÄ…cy i wychodzÄ…cy), a pÃ³Åºniej w miarÄ™ stawiania nowych usÅ‚ug, otwierasz dodatkowe porty komunikacyjne.

JeÅ›li TwÃ³j serwer nie posiada usÅ‚ugi WWW, ruch przychodzÄ…cy na portach 80 i 443 nie bÄ™dzie dla niego czymÅ› oczekiwanym. MoÅ¼esz wiÄ™c to wyciÄ…Ä‡.

Skorzystaj z poradnikÃ³w (i/lub skryptÃ³w) do konfiguracji podstawowego firewalla. PamiÄ™taj takÅ¼e, aby nie zrobiÄ‡ podstawowego bÅ‚Ä™du poczÄ…tkujÄ…cego admina i nie doprowadziÄ‡ do odciÄ™cia siebie samego od konfigurowanej wÅ‚aÅ›nie maszyny.

 * Niestandardowy port SSH

Wiele zautomatyzowanych atakÃ³w sieciowych, wycelowane jest w port numer 22. Robot sprawdza, czy port jest otwarty i czy sÅ‚ucha tam SSH, po czym zwykle przystÄ™puje do sprawdzania domyÅ›lnych haseÅ‚ logowania (typowy atak sÅ‚ownikowy).

ZmieniajÄ…c port na dowolny wysoki (1024+) zmniejszasz ryzyko ataku przez automaty (przynajmniej niektÃ³re).

Zmiana numeru portu czasami moÅ¼e generowaÄ‡ problemy. JeÅ›li na jakiÅ› natrafisz, moÅ¼esz pozostaÄ‡ przy domyÅ›lnym numerze portu i skorzystaÄ‡ z nastÄ™pnej porady.

 * Ograniczenie dostÄ™pu do SSH

Prawdopodobnie wiesz z jakich teoretycznych lokalizacji moÅ¼esz logowaÄ‡ siÄ™ na swÃ³j serwer. PrzewaÅ¼nie jest to praca, dom, uczelnia itp.

KaÅ¼de z tych miejsc wychodzi na Å›wiat z okreÅ›lonej puli IP (adres bywa zmienny, jednak pula jest zazwyczaj staÅ‚a).

MoÅ¼esz ograniczyÄ‡ na firewallu dostÄ™p do portu SSH, jedynie z okreÅ›lonego zakresu IP.

Zakres ten moÅ¼e byÄ‡ nawet skrajnie szeroki (maski IP rzÄ™du /24, /16 czy niekiedy /8).

 * Awaryjny dostÄ™p do SSH

Niekiedy musisz zalogowaÄ‡ siÄ™ na serwer z niestandardowej lokalizacji, dla ktÃ³rej nie otworzyÅ‚eÅ› dostÄ™pÃ³w na firewallu (np. Å‚Ä…czÄ…c siÄ™ z WiFi w kawiarni).

W takich przypadkach, uÅ¼ywam serwera zwanego przeze mnie â€˜jumpboxemâ€™. Jest to dowolny, zaufany serwer (lub grupa serwerÃ³w) do ktÃ³rego mam dostÄ™p, a ktÃ³rego adres(y) IP sÄ… wpisane w reguÅ‚ach firewalla, ktÃ³re przygotowywaÅ‚em.

Na co dzieÅ„ nie korzystam z tego serwera do logowania siÄ™, ale w wyjÄ…tkowych sytuacjach, moÅ¼e on byÄ‡ dla mnie ostatniÄ… deskÄ… ratunku.

    Zadbaj o to, aby w Twojej regule firewalla, zapewniony byÅ‚ dostÄ™p z minimum jednej maszyny ze staÅ‚ym adresem IP, do ktÃ³rej bÄ™dziesz miaÅ‚ staÅ‚y dostÄ™p przez sieÄ‡ (np. jakiÅ› malutki VPS). Zadbaj oczywiÅ›cie o bezpieczeÅ„stwo tej maszyny ;)

 * Wycinanie atakujÄ…cych

Osoba (lub automat), ktÃ³ra dziesiÄ…tki razy prÃ³buje bezskutecznie zalogowaÄ‡ siÄ™ na TwÃ³j serwer, to prawdopodobnie nic dobrego.

Warto wiÄ™c automatycznie odcinaÄ‡ dostÄ™p takim intruzom.

Najprostsza metoda, to instalacja pakietu fail2ban. DomyÅ›lna konfiguracja powinna wystarczyÄ‡ do ochrony logowania przez SSH.

MoÅ¼esz takÅ¼e rozbudowaÄ‡ domyÅ›lny config tak, aby szukaÅ‚ Å›ladÃ³w atakÃ³w bruteforce, takÅ¼e w logach innych usÅ‚ug.

 * Montowanie partycji

RozwaÅ¼ moÅ¼liwoÅ›Ä‡ trzymania kluczowych katalogÃ³w systemowych (/home/, /var/log/, /var/tmp/, /tmp/ itp) na oddzielnych partycjach. Najlepiej wykorzystaj LVM, aby uniknÄ…Ä‡ problemÃ³w z rozmiarem wolumenu.

Podmontuj wyÅ¼ej wymienione katalogi z opcjami nosuid + nodev.

Polecanym rozwiÄ…zaniem jest teÅ¼ ustawienie tzw. sticky bit na /tmp/ (chmod o+t /tmp/).

Radykalni admini sugerujÄ… dodanie opcji noexec na katalogi tymczasowe (/tmp/ i /var/tmp/), ale z doÅ›wiadczenia wiem, Å¼e niekiedy powoduje to problemy, wiÄ™c sam tego unikam.

 * Partycje w trybie read-only

NiektÃ³re z systemÃ³w specjalnego przeznaczenia, zbudowane sÄ… tak, Å¼e zaledwie niewielka ich czÄ™Å›Ä‡ ulega zmianie.

PrzykÅ‚adowo, niektÃ³rzy admini deydujÄ… siÄ™ na montowanie w trybie tylko-do-odczytu katalogÃ³w takich jak:

/etc/
/usr/
/lib/
/boot/

PowyÅ¼sze katalogi przewaÅ¼nie nie powinny byÄ‡ nigdy aktualizowane przez uÅ¼ytkownikÃ³w, a ich zawartoÅ›Ä‡ ulega zmianie jedynie podczas rekonfiguracji serwera (co nie zdarza siÄ™ na produkcji za czÄ™sto) lub podczas aktualizacji systemu. W obu przypadkach, administrator moÅ¼e przed przystÄ…pieniem do pracy, przemontowaÄ‡ zasoby RO w tryb RW.

Takie rozwiÄ…zanie utrudnia potencjalnemu wÅ‚amywaczowi (ktÃ³ry dostaÅ‚ siÄ™ do systemu, ale nie zdobyÅ‚ roota) na wprowadzanie istotnych zmian w systemie, czy na ukrywanie zÅ‚oÅ›liwego oprogramowania w czeluÅ›ciach dysku.

Temat uÅ¼ywania partycji read-only ma swoich zwolennikÃ³w, jak i przeciwnikÃ³w, wiÄ™c decyzja o wyborze takiego rozwiÄ…zania powinna byÄ‡ dostosowana do specyfiki uÅ¼ycia konkretnego serwera.

 * Chrooty i kontenery

JeÅ›li to moÅ¼liwe, uruchamiaj poszczegÃ³lne usÅ‚ugi w oddzielnych kontenerach (np. docker czy OpenVZ) lub przynajmniej w chrootowanym Å›rodowisku.

Takie rozwiÄ…zanie doÅ‚oÅ¼y Ci nieco pracy na poczÄ…tku, jednak zarzÄ…dzanie takim Å›rodowiskiem i debugowanie ewentualnych problemÃ³w z usÅ‚ugami bÄ™dzie pÃ³Åºniej prostsze.

Dodatkowo, zyskujesz kolejnÄ… warstwÄ™ zabezpieczeÅ„. W razie wÅ‚amania do ktÃ³rejkolwiek z usÅ‚ug, agresor dostaje siÄ™ jedynie do odizolowanego kontenera, a nie do caÅ‚ej maszyny, przez co pozostaÅ‚e usÅ‚ugi nadal sÄ… bezpieczne.

 * Otwarte porty publiczne

Wiele usÅ‚ug sieciowych, domyÅ›lnie nasÅ‚uchuje na wszystkich dostÄ™pnych adresach IP serwera (0.0.0.0).

Nie zawsze jest to dobre rozwiÄ…zanie, poniewaÅ¼ nie wszystkie usÅ‚ugi chcemy wystawiaÄ‡ na Å›wiat.

JeÅ›li wykorzystujesz np. serwer baz danych, czy memcache tylko lokalnie, to ustaw bindowanie portu usÅ‚ugi na 127.0.0.1.

JeÅ›li juÅ¼ musisz otworzyÄ‡ port dla poÅ‚Ä…czeÅ„ zewnÄ™trznych, to przynajmniej zdefiniuj na firewallu jakieÅ› ograniczenia tego, skÄ…d uÅ¼ytkownicy mogÄ… siÄ™ do niego Å‚Ä…czyÄ‡ (zakÅ‚adam np., Å¼e ze zdalnego serwera baz danych, korzysta ograniczona pula adresÃ³w IP).

    PowyÅ¼sza zasada oczywiÅ›cie nie dotyczy serwerÃ³w, ktÃ³re z definicji powinny byÄ‡ dostÄ™pne dla kaÅ¼dego (np. serwer stron WWW).

 * Ukrywania wersji oprogramowania

JeÅ›li to moÅ¼liwe, spraw, aby poszczegÃ³lne usÅ‚ugi dziaÅ‚ajÄ…ce na Twoim serwerze nie zdradzaÅ‚y wersji oprogramowania, ktÃ³re je obsÅ‚uguje.

Dotyczy to przede wszystkim usÅ‚ug wystawionych na Å›wiat, a wiÄ™c zwrÃ³Ä‡ uwagÄ™ na serwer WWW, obsÅ‚ugÄ™ PHP, czy wersjÄ™ uruchamianych aplikacji webowych.

Automatyczne ataki czÄ™sto skierowane sÄ… na konkretnÄ… wersjÄ™ oprogramowania i dla zaoszczÄ™dzenia czasu pomijajÄ… te serwery, dla ktÃ³rych wersja ta nie jest zgodna z wersjÄ… exploita.

Brak prezentacji np. wersji Apache, moÅ¼e zaoszczÄ™dziÄ‡ Ci kilku dodatkowych prÃ³b ataku miesiÄ™cznie.

    nie kaÅ¼dy program umoÅ¼liwia ukrycie swojej wersji. Niekiedy bÄ™dzie to wymagaÅ‚o przekompilowania ÅºrÃ³deÅ‚ (jak np. w przypadku nginx).

 * Backup logÃ³w

PrzyjÄ™Å‚o siÄ™, Å¼e backupujemy gÅ‚Ã³wnie dane uÅ¼ytkownikÃ³w, a logi po prostu rotujemy dla oszczÄ™dnoÅ›ci miejsca na dysku.

Niestety, wÅ‚amywacze czÄ™sto pozostajÄ… ukryci w systemie nawet tygodniami od daty wÅ‚amania, zanim wykonajÄ… swÃ³j pierwszy krok.

PosiadajÄ…c jedynie logi z ostatnich 4â€“5 dni, nie bÄ™dziesz w stanie namierzyÄ‡ ÅºrÃ³dÅ‚a ataku, ani metody jakÄ… posÅ‚uÅ¼yÅ‚ siÄ™ atakujÄ…cy.

Dobrym zwyczajem jest okresowe wysyÅ‚anie zrotowanych logÃ³w na zdalny serwer, lub nawet logowanie niektÃ³rych zdarzeÅ„ na dwa serwery jednoczeÅ›nie (lokalny i zdalny).

 * Poprawny backup

ZapamiÄ™taj:

    replika bazy danych to NIE jest backup
    RAID to NIE jest backup
    snapshot LVM to NIE jest backup (to rozwiÄ…zanie, ktÃ³re moÅ¼e byÄ‡ uÅ¼yte jako podrÄ™czny backup, ale nie jako backup persystentny)
    jeden punkt backupowy w czasie, to kiepski backup (trzymaj np. backupy z ostatnich 3 dni + jeden sprzed tygodnia + jeden sprzed miesiÄ…ca)

    Zadbaj o to, aby TwÃ³j backup byÅ‚ konsystentny (kopiujÄ…c pliki, uÅ¼yteczny moÅ¼e byÄ‡ tutaj snapshot LVM, ktÃ³ry â€˜zamroziâ€™ na chwilÄ™ obraz partycji)â€Šâ€”â€ŠzwÅ‚aszcza w przypadku backupowania baz danych. Kopie baz wykonuj zawsze z uÅ¼yciem oprogramowania dedykowanego do backupowania konkretnego silnika DB.

 * Koniec

Mam nadziejÄ™, Å¼e wiedza zdobyta w tym poradniku zostanie przez Ciebie wprowadzona w Å¼ycie i podniesie ogÃ³lne bezpieczeÅ„stwo Twoich serwerÃ³w.

PamiÄ™taj, Å¼e zaprezentowane tutaj porady to absolutne podstawy. Tematyka zabezpieczania serwerÃ³w linuksowych jest bardzo szeroka i nie da siÄ™ jej zawrzeÄ‡ w jednym, krÃ³tkim artykule.

    JeÅ›li tekst Ci siÄ™ spodobaÅ‚, kliknij ğŸ’š na dole (jeÅ›li masz konto na Medium) i/lub udostÄ™pnij ten poradnik na Twitterze/Facebooku.

Kontakt z autorem

jakub@mrugalski.pl
fb.me/jakub.mrugalski

